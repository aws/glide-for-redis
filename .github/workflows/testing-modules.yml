name: Modules Testing

on:
    pull_request:
      paths:
        - ./python/python/*
        - .github/workflows/testing-modules.yml
        - .github/workflows/start-self-hosted-runner/action.yml

concurrency:
        group: pypi-${{ github.head_ref || github.ref }}
        cancel-in-progress: true

jobs:
    start-self-hosted-runner:
        if: github.repository_owner == 'aws'
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v4
          - name: Start self hosted EC2 runner
            uses: ./.github/workflows/start-self-hosted-runner
            with:
                aws-access-key-id: ${{ secrets.AWS_EC2_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_EC2_SECRET_ACCESS_KEY }}
                aws-region: ${{ secrets.AWS_REGION }}
                ec2-instance-id: ${{ secrets.AWS_EC2_INSTANCE_ID }}
    
    test-python-modules:
        needs: start-self-hosted-runner
        if: github.repository_owner == 'aws'
        name: test python modules
        runs-on: [self-hosted, Linux, ARM64]
        steps:
            - name: Setup self-hosted runner access
              run: sudo chown -R $USER:$USER /home/ubuntu/actions-runner/_work/glide-for-redis
            
            - uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Set up Python 3.10
              run: |
                  sudo apt update -y
                  sudo apt upgrade -y
                  sudo apt install python3 python3-venv python3-pip -y

            - name: Install dependencies
              working-directory: ./python
              run: |
                  python3 -m pip install --upgrade pip
                  pip3 install flake8 isort black mypy-protobuf

            - name: Build Python wrapper
              uses: ./.github/workflows/build-python-wrapper
              with:
                    os: ubuntu
                    target: aarch64-unknown-linux-gnu
                    publish: "false"
                    github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Test with pytest
              working-directory: ./python
              run: |
                  source .env/bin/activate
                  cd python/tests/tests_redis_modules/
                  pytest --asyncio-mode=auto --override-ini=addopts= --cluster-endpoints=${{ secrets.CLUSTER_ENDPOINT }} --standalone-endpoints=${{ secrets.STANDALONE_ENDPOINT }}
    
    test-node-modules:
        needs: start-self-hosted-runner
        if: github.repository_owner == 'aws'
        name: test node modules
        runs-on: [self-hosted, Linux, ARM64]
        steps:
              - name: Setup self-hosted runner access
                run: sudo chown -R $USER:$USER /home/ubuntu/actions-runner/_work/glide-for-redis
          
              - uses: actions/checkout@v4
                with:
                  submodules: recursive
              
              - name: Use Node.js 16.x
                uses: actions/setup-node@v3
                with:
                    node-version: 16.x

              - name: Build Node wrapper
                uses: ./.github/workflows/build-node-wrapper
                with:
                  os: ubuntu
                  arch: arm64
                  target: aarch64-unknown-linux-gnu
                  publish: "false"
                  github-token: ${{ secrets.GITHUB_TOKEN }}
              
              - name: test redis modules
                run: npm run test-modules -- --cluster-endpoints=${{ secrets.CLUSTER_ENDPOINT }} --standalone-endpoints=${{ secrets.STANDALONE_ENDPOINT }}
                working-directory: ./node


            
